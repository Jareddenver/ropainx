<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ropainx</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">


</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Velco</h1>
            <p>Generate tweets automatically via extension</p>
            <div class="status" id="status">Checking connection...</div>
            <div class="user-profile" id="userProfile">
                <div class="pro-log">
                    <div class="profile-section">
                        <img src="https://via.placeholder.com/40" alt="Profile" id="userPhoto">
                        <div class="profile-info">
                            <div class="username" id="userName">User</div>
                            <div class="handle" id="userHandle">@username</div>
                        </div>
                        <button id="moreBtn" class="more-btn">⋯</button>
                        <div id="dropdownMenu" class="dropdown-menu z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg" dir="ltr" tabindex="-1" data-orientation="vertical">
                            <div class="px-3 py-2 font-semibold text-sm"><span id="dropdownUserName">User</span><span class="block font-normal text-xs opacity-70" id="dropdownUserHandle">@username</span></div>
                            <div role="separator" aria-orientation="horizontal" class="-mx-1 my-1 h-px bg-border"></div>
                            <a id="dropdownPayment" role="menuitem" class="relative flex cursor-default select-none items-center rounded-sm px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50" data-orientation="vertical" data-radix-collection-item="" href="/payment.html">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card mr-2 size-4"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>Payment
                            </a>
                            <div id="dropdownLogout" role="menuitem" class="relative flex cursor-default select-none items-center rounded-sm px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50" data-orientation="vertical" data-radix-collection-item="">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out mr-2 size-4"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        <div class="filter-selector" id="filterSelector">
    <div class="filter-tag" data-filter="tweet-viral">
       <svg height="14px" width="14px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path style="fill:#4dc3ff;" d="M405.75,286.71l-22.028-38.16h-13.467c-8.947,0-16.2-7.253-16.2-16.2V90.477 c0-0.213-0.179-0.393-0.393-0.393h-9.901c-8.947,0-16.2-7.253-16.2-16.2V61.837c0-15.021,12.219-27.24,27.24-27.24H484.76 c15.021,0,27.24,12.22,27.24,27.24v159.472c0,15.02-12.219,27.24-27.24,27.24h-28.921l-22.028,38.16 C427.578,297.506,411.972,297.487,405.75,286.71z"></path> <path style="fill:#4dc3ff;" d="M78.189,286.71l-22.028-38.161H27.24C12.219,248.549,0,236.33,0,221.309V61.837 c0-15.021,12.219-27.24,27.24-27.24h129.958c15.026,0,27.251,12.22,27.251,27.24v12.047c0,8.947-7.253,16.2-16.2,16.2h-9.901 c-0.213,0-0.393,0.179-0.393,0.393v141.872c0,8.947-7.253,16.2-16.2,16.2h-13.469l-22.038,38.162 C100.014,297.508,84.423,297.508,78.189,286.71z"></path> <path style="fill:#ffdd00;" d="M256.006,432.447L256.006,432.447c-5.788,0-11.136-3.088-14.029-8.1l-35.456-61.414H158.35 c-18.083,0-32.794-14.711-32.794-32.794V90.477c0-18.083,14.711-32.794,32.794-32.794h195.312c18.083,0,32.794,14.711,32.794,32.794 v239.662c0,18.083-14.711,32.794-32.794,32.794h-48.17l-35.458,61.414C267.142,429.359,261.793,432.447,256.006,432.447z"></path> <path style="fill:#4dc3ff;" d="M353.662,57.683h-97.657v374.762c5.788,0,11.136-3.088,14.029-8.1l35.458-61.414h48.17 c18.083,0,32.794-14.711,32.794-32.794V90.477C386.456,72.394,371.745,57.683,353.662,57.683z"></path> <g> <path style="fill:#0597ff;" d="M256.003,207.22c-27.743,0-50.314-22.57-50.314-50.314s22.57-50.314,50.314-50.314 c27.743,0,50.315,22.57,50.315,50.314S283.746,207.22,256.003,207.22z"></path> <path style="fill:#0597ff;" d="M328.521,315.53H183.484c-8.947,0-16.2-7.253-16.2-16.2c0-48.919,39.8-88.719,88.719-88.719 c48.92,0,88.719,39.8,88.719,88.719C344.722,308.278,337.468,315.53,328.521,315.53z"></path> </g> <path style="fill:#D1D3D4;" d="M450.894,477.403H61.118c-8.947,0-16.2-7.253-16.2-16.2c0-8.947,7.253-16.2,16.2-16.2h389.776 c8.947,0,16.2,7.253,16.2,16.2C467.094,470.15,459.841,477.403,450.894,477.403z"></path> <g> <path style="fill:#0597ff;" d="M306.317,156.906c0-27.742-22.569-50.311-50.311-50.314V207.22 C283.747,207.219,306.317,184.649,306.317,156.906z"></path> <path style="fill:#0597ff;" d="M256.006,210.612v104.919h72.516c8.947,0,16.2-7.253,16.2-16.2 C344.722,250.412,304.924,210.613,256.006,210.612z"></path> </g> <path style="fill:#BCBEC0;" d="M450.894,445.003H256.006v32.4h194.888c8.947,0,16.2-7.253,16.2-16.2 C467.094,452.256,459.841,445.003,450.894,445.003z"></path> </g></svg>
        Viral Tweet
    </div>
    <div class="filter-tag" data-filter="critique-constructive">
        <svg width="14px" height="14px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <defs> <polygon id="alert-a" points="2.758 .388 19.133 .388 21.288 4.068 19.896 4.965 2.592 4.965 .87 4.068"></polygon> <path id="alert-c" d="M12,2 L3,18 L21,18 L12,2 Z M10.2568489,1.01947752 C11.0214571,-0.33982584 12.9785429,-0.33982584 13.7431511,1.01947752 L22.7431511,17.0194775 C23.4930806,18.3526856 22.529653,20 21,20 L3,20 C1.47034705,20 0.506919374,18.3526856 1.25684893,17.0194775 L10.2568489,1.01947752 Z M11,11 L11,16 C11,16.5522847 11.4477153,17 12,17 C12.5522847,17 13,16.5522847 13,16 L13,11 C13,10.4477153 12.5522847,10 12,10 C11.4477153,10 11,10.4477153 11,11 Z M12,9 C12.5522847,9 13,8.55228475 13,8 C13,7.44771525 12.5522847,7 12,7 C11.4477153,7 11,7.44771525 11,8 C11,8.55228475 11.4477153,9 12,9 Z"></path> </defs> <g fill="none" fill-rule="evenodd" transform="translate(0 2)"> <g transform="translate(1 14)"> <mask id="alert-b" fill="#ffffff"> <use xlink:href="#alert-a"></use> </mask> <use fill="#D8D8D8" xlink:href="#alert-a"></use> <g fill="#FFA0A0" mask="url(#alert-b)"> <rect width="24" height="24" transform="translate(-1 -16)"></rect> </g> </g> <mask id="alert-d" fill="#ffffff"> <use xlink:href="#alert-c"></use> </mask> <use fill="#000000" fill-rule="nonzero" xlink:href="#alert-c"></use> <g fill="#7600FF" mask="url(#alert-d)"> <rect width="24" height="24" transform="translate(0 -2)"></rect> </g> </g> </g></svg>
        Constructive Critique
    </div>
    <div class="filter-tag" data-filter="thread-twitter">
     <svg fill="#ff8f8f" height="14px" width="14px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" stroke="#ff8f8f"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M201.275,96.165l-11.919,11.919c-26.292,26.288-69.069,26.291-95.361,0C73.27,87.359,68.273,55.9,81.564,29.807 c4.226-8.296,0.925-18.446-7.371-22.672c-8.294-4.228-18.446-0.926-22.672,7.371c-19.938,39.146-12.449,86.334,18.636,117.419 c39.438,39.438,103.606,39.436,143.039,0l11.919-11.919c12.858-12.856,27.97-22.117,44.074-27.789 c11.784-14.763,22.661-28.319,32.306-40.252C265.03,53.649,229.061,68.381,201.275,96.165z"></path> </g> </g> <g> <g> <path d="M482.189,430.439c-26.096,13.286-57.55,8.288-78.274-12.435c-12.735-12.735-19.749-29.668-19.749-47.679 s7.014-34.944,19.749-47.68l11.92-11.92c38.118-38.118,51.665-91.639,40.656-140.712c16.229-13.253,27.199-22.501,30.862-26.166 c32.862-32.863,32.862-86.335,0-119.198c-32.863-32.863-86.336-32.863-119.199,0C341.393,51.407,17.343,467.097,3.562,484.779 c-5.23,6.71-4.64,16.267,1.377,22.282c3.27,3.271,7.587,4.938,11.924,4.938c3.64,0,7.296-1.174,10.358-3.561 c13.964-10.882,276.103-215.232,398.944-313.896c2.484,33.111-8.903,67.077-34.169,92.343l-11.92,11.92 c-19.104,19.104-29.624,44.503-29.624,71.52c0,27.016,10.521,52.416,29.625,71.519c19.485,19.486,45.291,29.7,71.484,29.698 c15.59-0.001,31.322-3.621,45.927-11.06c8.297-4.224,11.597-14.375,7.372-22.671C500.635,429.514,490.482,426.215,482.189,430.439 z M415.835,96.165l-0.001-0.001l-23.84,23.84l0.001,0.001c4.047,4.047,7.73,8.321,11.064,12.774l-11.065,11.065 c-3.292,3.292-7.607,4.938-11.919,4.938c-4.314,0-8.629-1.645-11.919-4.938c-6.583-6.582-6.583-17.256,0-23.84l47.68-47.679 c6.583-6.583,17.257-6.583,23.84,0c6.583,6.582,6.583,17.256,0,23.84l-12.587,12.586 C423.608,104.401,419.864,100.194,415.835,96.165z"></path> </g> </g> </g></svg>
        Twitter Thread
    </div>
    <div class="filter-tag" data-filter="reformulation-simple">
        <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14px" height="14px" viewBox="0 0 948.492 948.493" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M364.973,156c56.078-18.02,115.836-19.057,172.815-2.999c0.001,0,0.003,0.001,0.004,0.001 c37.999,10.709,72.86,28.363,103.62,52.472c22.818,17.886,55.818,13.888,73.707-8.933c17.887-22.82,13.888-55.819-8.934-73.707 c-41.592-32.602-88.667-56.455-139.916-70.898c-76.911-21.676-157.625-20.259-233.419,4.096 c-60.358,19.395-114.889,52.355-159.759,96.27l22.875-81.167c7.865-27.908-8.383-56.907-36.291-64.772 c-27.909-7.866-56.907,8.383-64.772,36.291L40.955,234.083c-7.865,27.908,8.383,56.907,36.291,64.772L266.1,352.078 c4.763,1.342,9.553,1.982,14.27,1.981c22.917-0.001,43.98-15.127,50.504-38.272c7.864-27.908-8.384-56.907-36.291-64.772 l-55.853-15.74C273.376,198.765,316.649,171.528,364.973,156z"></path> <path d="M98.192,693.214c11.267,13.058,23.409,25.436,36.38,37.055c47.219,42.304,103.206,72.727,163.768,89.279l-81.608,21.244 c-28.06,7.304-44.886,35.973-37.581,64.032c6.15,23.626,27.445,39.287,50.771,39.287c4.377,0,8.827-0.553,13.261-1.706 l192.469-50.103c13.476-3.507,25.004-12.224,32.053-24.232c7.048-12.008,9.036-26.325,5.528-39.799l-49.428-189.884 c-7.304-28.06-35.971-44.886-64.032-37.581c-28.06,7.305-44.886,35.974-37.581,64.032l14.618,56.156 c-49.009-11.469-94.371-35.065-132.175-68.933c-43.872-39.304-74.943-90.359-89.856-147.648 c-9.946-38.208-12.313-77.215-7.036-115.939c3.916-28.729-16.201-55.192-44.93-59.107c-28.727-3.916-55.192,16.2-59.108,44.93 c-7.136,52.362-3.953,105.04,9.461,156.568C28.891,591.281,57.955,646.581,98.192,693.214z"></path> <path d="M799.62,234.101c-20.625-20.379-53.866-20.18-74.245,0.445l-129.913,131.48c-20.379,20.625-20.181,53.866,0.444,74.246 c20.625,20.379,53.866,20.18,74.245-0.445l38.56-39.023c7.103,24.381,11.07,49.487,11.839,74.765 c0.269,8.86,0.146,17.743-0.371,26.623c-0.207,3.552-0.477,7.103-0.81,10.651c-1,10.647-2.567,21.276-4.708,31.847 c-11.69,57.729-39.995,110.37-81.854,152.229c-27.917,27.917-60.36,49.703-96.428,64.753c-26.759,11.165-39.4,41.909-28.234,68.668 c8.409,20.152,27.92,32.297,48.474,32.297c6.737,0,13.589-1.306,20.194-4.062c48.771-20.351,92.59-49.758,130.241-87.409 c56.502-56.502,94.719-127.61,110.521-205.637c2.404-11.876,4.273-23.811,5.608-35.768c1.068-9.565,1.795-19.146,2.183-28.728 c0.387-9.581,0.434-19.16,0.142-28.723c-0.76-24.908-3.833-49.695-9.163-74.074l42.749,42.239 c10.232,10.11,23.567,15.155,36.898,15.155c13.541,0,27.077-5.207,37.347-15.6c20.379-20.625,20.18-53.866-0.445-74.245 L799.62,234.101z"></path> </g> </g></svg>
        Simple Reformulation
    </div>
    <div class="filter-tag" data-filter="angle-contrarian">
        <svg height="14px" width="14px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path style="fill:#F72349;" d="M144.696,321.67V512h33.391v-66.783c32.723,0,60.274-22.073,68.624-52.136 C246.711,393.081,173.635,341.704,144.696,321.67z"></path> <path style="fill:#F72349;" d="M389.565,512h33.391V378.435c-10.017,0-18.922,1.113-33.391,1.113V512z"></path> </g> <path style="fill:#FB5858;" d="M400.696,211.478c0-18.442-14.949-33.391-33.391-33.391v44.522L384,235.965l16.696-13.357V211.478z"></path> <path style="fill:#FBB071;" d="M162.504,329.461c0,0,19.916,49.095,19.702,51.341l64.504,12.28l76.072,14.481l30.052-46.937 L162.504,329.461z"></path> <path style="fill:#FF835D;" d="M322.783,373.571V512h33.391v-98.895c11.769,0.834,22.997-0.233,33.391-2.993 c12.497-3.319,23.794-9.077,33.391-16.887c20.614-16.774,33.391-43.011,33.391-74.894l-42.296-23.374 C397.357,308.313,322.783,373.571,322.783,373.571z"></path> <polygon style="fill:#FAE8AC;" points="422.957,318.33 456.348,318.33 456.348,263.421 398.47,248.209 "></polygon> <path style="fill:#F72349;" d="M500.87,222.609h-44.522v-11.13c0-18.442-14.949-33.391-33.391-33.391v44.522h-55.652v66.783h-44.522 l-33.391,42.296l33.391,41.884l26.301,5.009c5.053,0.957,10.017,1.425,14.815,1.425c14.759,0,28.049-4.441,38.367-13 c13.345-11.064,20.691-28.349,20.691-48.673v-49.345l33.391-5.565L500.87,256V222.609z"></path> <path style="fill:#FB5858;" d="M111.304,289.391V107.583L66.783,79.026l-44.531,28.557c-7.208,20.643-11.122,42.846-11.122,65.949 c0,74.165,40.29,138.904,100.174,173.546v42.487H77.913V512h33.391v-66.783c12.069,0,23.43-3.012,33.391-8.309 c15.304-8.137,27.287-21.688,33.391-38.104c2.117-5.693,3.524-11.729,4.119-18.002c0.214-2.245,0.333-4.518,0.333-6.82v-27.108 l140.243,26.696v-84.179H111.304z"></path> <path style="fill:#FAE8AC;" d="M111.304,0C70.086,23.844,38.147,61.954,22.252,107.583h89.052V0z"></path> </g></svg>
        Contrarian Angle
    </div>
    <div class="filter-tag" data-filter="storytelling">
       <svg width="14px" height="14px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M7.42598 18H20C19.9965 18.9296 19.9784 19.6228 19.8866 20.1706C19.7773 20.8228 19.5774 21.1682 19.2709 21.4142C18.9643 21.6602 18.5339 21.8206 17.7211 21.9083C16.8844 21.9986 15.7754 22 14.1854 22H9.75461C8.1646 22 7.05566 21.9986 6.21896 21.9083C5.40616 21.8206 4.97573 21.6602 4.66916 21.4142C4.36259 21.1682 4.16271 20.8228 4.05343 20.1706C4.04522 20.1216 4.03761 20.0714 4.03053 20.02C3.99045 19.7288 3.97041 19.5831 4.09696 19.2397C4.22351 18.8964 4.27837 18.8425 4.38811 18.7347C4.71351 18.4151 5.15982 18.1785 5.67321 18.0681C5.96352 18.0057 6.34236 18 7.42598 18Z" fill="#1C274D"></path> <path opacity="0.5" d="M4.72718 2.73332C5.03258 2.42535 5.46135 2.22456 6.27103 2.11478C7.10452 2.00177 8.2092 2 9.7931 2H14.2069C15.7908 2 16.8955 2.00177 17.729 2.11478C18.5387 2.22456 18.9674 2.42535 19.2728 2.73332C19.5782 3.0413 19.7773 3.47368 19.8862 4.2902C19.9982 5.13073 20 6.24474 20 7.84202L20 18H7.42598C6.34236 18 5.96352 18.0057 5.67321 18.0681C5.15982 18.1785 4.71351 18.4151 4.38811 18.7347C4.27837 18.8425 4.22351 18.8964 4.09696 19.2397C4.02435 19.4367 4 19.5687 4 19.7003V7.84202C4 6.24474 4.00176 5.13073 4.11382 4.2902C4.22268 3.47368 4.42179 3.0413 4.72718 2.73332Z" fill="#1C274D"></path> <path d="M7.25 7C7.25 6.58579 7.58579 6.25 8 6.25H16C16.4142 6.25 16.75 6.58579 16.75 7C16.75 7.41421 16.4142 7.75 16 7.75H8C7.58579 7.75 7.25 7.41421 7.25 7Z" fill="#1C274D"></path> <path d="M8 9.75C7.58579 9.75 7.25 10.0858 7.25 10.5C7.25 10.9142 7.58579 11.25 8 11.25H13C13.4142 11.25 13.75 10.9142 13.75 10.5C13.75 10.0858 13.4142 9.75 13 9.75H8Z" fill="#1C274D"></path> </g></svg>
        Storytelling
    </div>
    <div class="filter-tag" data-filter="question-provocante">
       <svg height="14px" width="14px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path style="fill:#FFDB6C;" d="M151.292,326.199c0,33.267,0,39.494,0,72.76c0,64.932,43.25,104.826,96.6,104.826h5.962h5.962 c53.351,0,96.6-39.894,96.6-104.826c0-33.267,0-39.493,0-72.76H151.292z M237.676,388.49l-9.638,2.879 c-21.352,6.379-43.833-5.758-50.213-27.11l9.637-2.879C208.815,355,231.295,367.138,237.676,388.49L237.676,388.49z M279.669,391.369l-9.637-2.879l0,0c6.379-21.352,28.86-33.49,50.212-27.11l9.637,2.879 C323.502,385.611,301.021,397.748,279.669,391.369z"></path> <path style="fill:#FFB04C;" d="M310.1,326.199c0,15.03,0,24.539,0,33.517c3.295,0.135,6.627,0.676,9.932,1.664l9.637,2.879 c-3.199,10.706-10.447,19.094-19.57,23.995c0,3.256,0,6.788,0,10.706c0,57.835-34.311,95.806-79.51,103.416 c5.547,0.934,11.258,1.411,17.09,1.411h5.962h5.962c53.351,0,96.6-39.894,96.6-104.826c0-33.267,0-39.493,0-72.76L310.1,326.199 L310.1,326.199z"></path> <path style="fill:#FD4DD7;" d="M191.197,31.787c-8.583-3.535-16.119,6.704-10.249,13.895c18.673,22.875,29.381,52.404,28.096,84.23 c-0.392,9.723-1.872,18.854-4.316,27.362v115.863h97.63V158.838C290.311,94.952,253.229,57.338,191.197,31.787z"></path> <circle style="fill:#FFDB6C;" cx="165.323" cy="25.901" r="17.687"></circle> <path style="fill:#FFB04C;" d="M171.346,9.271c-1.822-0.659-3.682-0.989-5.518-1.041c5.837,4.588,8.369,12.556,5.704,19.917 C168.867,35.509,161.82,40.01,154.4,39.8c1.445,1.136,3.084,2.073,4.906,2.732c9.185,3.325,19.326-1.426,22.65-10.611 S180.53,12.595,171.346,9.271z"></path> <circle style="fill:#FFDB6C;" cx="33.095" cy="224.067" r="17.687"></circle> <path style="fill:#FFB04C;" d="M39.119,207.434c-0.969-0.35-1.95-0.592-2.932-0.768c5.238,4.67,7.406,12.217,4.872,19.22 c-2.973,8.216-11.4,12.864-19.718,11.379c1.633,1.455,3.556,2.64,5.739,3.43c9.185,3.325,19.326-1.426,22.65-10.61 C53.054,220.9,48.304,210.759,39.119,207.434z"></path> <circle style="fill:#FFDB6C;" cx="478.71" cy="221.548" r="17.687"></circle> <path style="fill:#FFB04C;" d="M469.208,222.66c3.325-9.185,13.466-13.935,22.65-10.611c0.838,0.303,1.625,0.681,2.386,1.092 c-1.991-3.684-5.273-6.688-9.52-8.226c-9.185-3.325-19.326,1.426-22.65,10.611c-3.022,8.347,0.641,17.465,8.225,21.558 C467.985,232.802,467.421,227.596,469.208,222.66z"></path> <path style="fill:#FC4C59;" d="M356.727,273.139H152.411c-6.305,0-11.416,5.111-11.416,11.416v30.227 c0,6.305,5.111,11.416,11.416,11.416h204.317c6.305,0,11.416-5.111,11.416-11.416v-30.227 C368.144,278.25,363.033,273.139,356.727,273.139z"></path> <path style="fill:#E83A64;" d="M356.727,273.139h-41.909c6.305,0,11.416,5.111,11.416,11.416v30.227 c0,6.305-5.111,11.416-11.416,11.416h41.909c6.305,0,11.416-5.111,11.416-11.416v-30.227 C368.144,278.25,363.033,273.139,356.727,273.139z"></path> <path style="fill:#E846AA;" d="M298.534,142.394c-6.754,3.943-13.061,8.576-18.829,13.801c-9.666,8.756-25.137,1.849-25.137-11.193 l0,0c-9.47-50.217-34.417-84.197-74.782-108.85c-1.402,2.867-1.335,6.473,1.161,9.531c18.673,22.875,29.381,52.404,28.096,84.23 c-0.392,9.723-1.872,18.854-4.316,27.362v102.027h37.476v2.885h60.154v-103.35C301.285,153.148,300.004,147.677,298.534,142.394z"></path> <path style="fill:#7C54B8;" d="M160.477,273.139h94.372v-21.408c0-61.771-49.393-112.934-111.162-113.461 c-44.415-0.379-82.921,25.067-101.418,62.226c-3.748,7.528,4.979,15.29,12.005,10.669c11.673-7.677,25.646-12.144,40.663-12.144 C135.872,199.022,160.477,232.205,160.477,273.139z"></path> <path style="fill:#674799;" d="M160.477,273.139h47.34c0-52.723-26.277-95.697-82.175-96.174 c-31.779-0.27-60.528,12.683-81.092,33.685c2.589,2.094,6.351,2.735,9.725,0.516c11.674-7.677,25.646-12.144,40.663-12.144 C135.872,199.022,160.477,232.205,160.477,273.139z"></path> <path style="fill:#3CC247;" d="M348.739,273.139h-94.124v-21.408c0-61.771,49.393-112.934,111.162-113.461 c44.415-0.379,82.921,25.067,101.418,62.226c3.748,7.528-4.979,15.29-12.005,10.669c-11.673-7.677-25.646-12.144-40.663-12.144 C373.593,199.022,348.739,232.205,348.739,273.139z"></path> <path style="fill:#2DA85F;" d="M384.395,175.506c-56.403,0.481-90.997,42.082-90.997,97.633h55.342 c0-40.934,24.854-74.117,65.789-74.117c15.017,0,28.99,4.467,40.663,12.144c3.858,2.537,8.223,1.337,10.76-1.503 S445.356,188.383,416.411,175.232,384.395,175.506z"></path> <path d="M337.752,366.61c0.623-2.087,0.392-4.338-0.643-6.254s-2.789-3.345-4.877-3.968l-9.637-2.879 c-25.658-7.666-52.769,6.972-60.435,32.629c-1.299,4.347,1.172,8.922,5.518,10.221l9.637,2.88v0.001 c4.62,1.38,9.287,2.037,13.879,2.037C312.107,401.277,331.466,387.648,337.752,366.61z M306.488,380.986 c-7.553,4.078-16.245,4.973-24.468,2.513v0.001l-0.749-0.224c7.423-12.138,22.363-18.285,36.621-14.027l0.758,0.227 C315.727,374.279,311.569,378.243,306.488,380.986z"></path> <path d="M230.389,399.24C230.389,399.24,230.39,399.24,230.389,399.24l9.638-2.881c4.347-1.299,6.817-5.874,5.518-10.221 c-7.666-25.657-34.779-40.296-60.432-32.629l-9.638,2.879c-2.087,0.623-3.842,2.051-4.877,3.968s-1.266,4.167-0.642,6.254 c6.286,21.039,25.643,34.667,46.556,34.667C221.101,401.277,225.77,400.62,230.389,399.24z M189.065,369.473l0.749-0.223 c14.258-4.265,29.198,1.89,36.621,14.027l-0.749,0.225v-0.001C211.426,387.76,196.488,381.609,189.065,369.473z"></path> <path d="M250.241,473.382h7.224c20.607,0,39.423-8.924,51.622-24.485c2.799-3.57,2.173-8.733-1.396-11.531 c-3.57-2.798-8.733-2.175-11.531,1.396c-9.197,11.732-22.939,18.193-38.694,18.193h-7.224c-15.988,0-29.858-6.627-39.055-18.66 c-2.755-3.604-7.911-4.293-11.513-1.538c-3.604,2.755-4.293,7.91-1.539,11.514C210.332,464.229,229.324,473.382,250.241,473.382z"></path> <path d="M502.354,210.558c-2.936-6.265-8.135-11.012-14.639-13.365c-4.412-1.598-9.067-1.96-13.561-1.115 c-9.913-19.567-24.964-36.062-43.587-47.731c-19.41-12.161-41.858-18.487-64.859-18.289c-20.589,0.175-40.389,5.621-57.828,15.549 c-6.856-27.704-18.774-50.749-36.253-70.165c-18.688-20.757-43.972-37.521-77.301-51.249c-1.069-0.44-2.155-0.757-3.244-0.978 c-1.012-9.553-7.317-18.184-16.941-21.669c-13.429-4.859-28.308,2.111-33.169,15.538c-2.355,6.504-2.036,13.537,0.899,19.802 c2.935,6.266,8.134,11.013,14.639,13.366c2.878,1.043,5.859,1.561,8.831,1.561c2.972,0,5.935-0.527,8.777-1.558 c0.156,0.207,0.301,0.418,0.467,0.622c18.083,22.153,27.406,50.103,26.252,78.704c-0.205,5.062-0.741,10.015-1.583,14.825 c-16.588-8.994-35.472-14.179-55.497-14.35c-23.013-0.185-45.45,6.128-64.859,18.289c-18.867,11.821-34.076,28.588-43.981,48.489 c-0.222,0.447-0.421,0.9-0.6,1.356c-11.037-0.511-21.618,6.136-25.572,17.057c-2.355,6.504-2.035,13.537,0.899,19.802 s8.134,11.012,14.638,13.365c2.879,1.043,5.86,1.561,8.832,1.561c3.745,0,7.479-0.824,10.971-2.459 c6.265-2.935,11.012-8.134,13.367-14.639c1.756-4.852,1.96-9.89,0.882-14.579c0.15-0.092,0.304-0.174,0.452-0.272 c10.738-7.06,23.238-10.793,36.151-10.793c17.045,0,31.511,6.494,41.831,18.777c8.493,10.109,13.728,23.725,15.112,38.94 c-10.577,0.285-19.099,8.958-19.099,19.602v30.227c0,7.448,4.169,13.94,10.297,17.265v66.911c0,33.237,10.581,61.755,30.601,82.471 c19.05,19.714,45.406,30.57,74.214,30.57h11.924c28.808,0,55.164-10.856,74.214-30.57c20.018-20.716,30.6-49.233,30.6-82.471 c0,0,0-12.097,0-16.633v-16.633c0-4.537-3.676-8.214-8.214-8.214s-8.214,3.676-8.214,8.214c0,0,0,12.097,0,16.633v16.633 c0,56.884-36.346,96.614-88.386,96.614h-11.924c-52.041,0-88.387-39.729-88.387-96.614v-64.546h197.222 c10.823,0,19.629-8.806,19.629-19.63v-30.227c0-10.617-8.479-19.271-19.018-19.599c1.394-15.192,6.666-28.802,15.218-38.927 c10.387-12.296,24.9-18.795,41.97-18.795c12.913,0,25.413,3.732,36.15,10.793c0.78,0.513,1.586,0.952,2.411,1.319 c-0.389,4.48,0.398,9.004,2.356,13.186c2.935,6.265,8.134,11.012,14.639,13.367c2.901,1.049,5.868,1.546,8.789,1.546 c10.6,0,20.569-6.558,24.38-17.086C505.608,223.857,505.289,216.824,502.354,210.558z M162.101,34.808 c-3.872-1.402-6.457-5.276-6.238-9.397c0.204-3.819,2.752-7.192,6.354-8.451c7.527-2.633,14.947,5.147,11.88,12.516 C172.167,34.11,166.848,36.528,162.101,34.808C159.722,33.946,164.48,35.671,162.101,34.808z M33.161,233.542 c-3.935-0.042-7.553-2.471-8.933-6.155c-1.391-3.713-0.264-8.021,2.772-10.569c3.022-2.536,7.435-2.943,10.851-0.942 c3.898,2.283,5.697,7.152,4.156,11.411C41.145,229.667,37.639,233.59,33.161,233.542z M94.938,190.808 c-16.111,0-31.714,4.657-45.13,13.466c-0.057-0.048-0.114-0.095-0.171-0.142c8.557-17.181,21.692-31.656,37.985-41.865 c16.497-10.336,35.528-15.787,55.096-15.787c0.299,0,0.601,0.001,0.901,0.004c56.201,0.479,102.028,46.701,102.995,103.418 c-0.134,0.589-0.211,1.199-0.211,1.828v13.195h-78.025c-1.474-19.131-8.101-36.469-19.03-49.48 C135.804,199.327,116.99,190.808,94.938,190.808z M359.929,284.555v30.227c0,1.765-1.437,3.203-3.202,3.203H152.41 c-1.765,0-3.202-1.438-3.202-3.203v-30.227c0-1.765,1.437-3.202,3.202-3.202h8.067h94.138h0.234h93.889h7.989 C358.493,281.354,359.929,282.79,359.929,284.555z M414.528,190.808c-22.061,0-40.911,8.514-54.519,24.621 c-11.008,13.03-17.682,30.374-19.167,49.496h-77.778V251.73c0-39.96-19.313-75.602-48.988-97.826 c1.772-7.587,2.846-15.516,3.176-23.661c1.317-32.616-9.315-64.492-29.939-89.755c-0.153-0.188-0.278-0.349-0.208-0.596 c0.105-0.164,0.223-0.316,0.325-0.483c0.212-0.188,0.381-0.135,0.641-0.03c60.737,25.018,93.38,60.934,105.215,116.028 c-7.557,5.918-14.483,12.787-20.601,20.539c-2.81,3.561-2.201,8.726,1.36,11.535c3.56,2.81,8.726,2.202,11.535-1.36 c19.664-24.924,48.921-39.373,80.269-39.639c19.879-0.221,39.246,5.287,55.996,15.782c16.266,10.193,29.384,24.639,37.942,41.782 c-0.059,0.065-0.111,0.135-0.17,0.199C446.212,195.456,430.623,190.808,414.528,190.808z M477.327,230.887 c-4.918-0.826-8.45-5.52-7.834-10.49c0.706-5.707,6.593-9.575,12.102-7.933c5.147,1.534,8.046,7.237,6.213,12.305 C486.029,229.681,481.779,231.635,477.327,230.887z"></path> <circle cx="172.529" cy="299.665" r="7.995"></circle> <circle cx="204.66" cy="299.665" r="7.995"></circle> <circle cx="236.803" cy="299.665" r="7.995"></circle> <circle cx="268.945" cy="299.665" r="7.995"></circle> <circle cx="301.077" cy="299.665" r="7.995"></circle> <circle cx="333.22" cy="299.665" r="7.995"></circle> </g></svg>
        Provocative Question
    </div>
    <div class="filter-tag" data-filter="metaphore-creative">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.5 3A6.5 6.5 0 0 1 16 9.5C16 11.11 15.41 12.59 14.44 13.73L14.71 14H16.5C17.88 14 19 15.12 19 16.5V18.5C19 19.88 17.88 21 16.5 21H9.5C8.12 21 7 19.88 7 18.5V16.5C7 15.12 8.12 14 9.5 14H10.29L10.56 13.73C9.59 12.59 9 11.11 9 9.5A6.5 6.5 0 0 1 9.5 3ZM9.5 5C7.01 5 5 7.01 5 9.5S7.01 14 9.5 14S14 11.99 14 9.5S11.99 5 9.5 5Z"/>
        </svg>
        Creative Metaphor
    </div>
    <div class="filter-tag" data-filter="style-personnel">
       <svg width="14px" height="14px" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M645.3 656.8c12.6-2.7 21.4-13.6 22.5-26.1h0.1c0.6-6.7 1.7-13.3 3.3-19.8h-0.2c1.3-4.6 1.5-9.6 0.4-14.7-3.5-16.2-19.1-26.5-34.7-23.1-11.9 2.6-20.5 12.4-22.3 24.1-0.1 0.7-0.2 1.3-0.4 2-1.7 7.5-3 15.2-3.7 23-0.6 3.7-0.5 7.6 0.3 11.6 3.5 16.1 19 26.4 34.7 23zM513 753.6c-86.7 0-157.2-70.5-157.2-157.2 0-15.9 2.4-31.5 7-46.5 4.9-15.8 21.7-24.7 37.5-19.8 15.8 4.9 24.7 21.7 19.8 37.5-2.9 9.3-4.3 19-4.3 28.8 0 53.6 43.6 97.2 97.2 97.2 19.5 0 38.3-5.7 54.3-16.6 13.7-9.3 32.4-5.7 41.7 8.1 9.3 13.7 5.7 32.4-8.1 41.7-26 17.5-56.4 26.8-87.9 26.8z" fill="#33CC99"></path><path d="M576.1 303.4m-175.4 0a175.4 175.4 0 1 0 350.8 0 175.4 175.4 0 1 0-350.8 0Z" fill="#FFB89A"></path><path d="M513 121.4c39.7 0 77.1 15.5 105.1 43.5 28.1 28.1 43.5 65.4 43.5 105.1s-15.5 77.1-43.5 105.1c-28.1 28.1-65.4 43.5-105.1 43.5-39.7 0-77.1-15.5-105.1-43.5-28.1-28.1-43.5-65.4-43.5-105.1s15.5-77.1 43.5-105.1 65.4-43.5 105.1-43.5m0-60c-115.3 0-208.7 93.4-208.7 208.7S397.7 478.8 513 478.8c115.3 0 208.7-93.4 208.7-208.7S628.3 61.4 513 61.4z" fill="#45484C"></path><path d="M512.3 573.2c44.4 0 88.3 7.5 130.6 22.3 38.5 13.5 75.2 33.1 106.2 56.8 28.8 22 52.4 47.2 68.2 72.8 14 22.6 21.4 44.6 21.4 63.6 0 15.2-4.7 27.2-15.1 38.9-12.6 14.1-32.8 26.6-60 37.3-58.9 23.1-145.8 35.3-251.3 35.3S319.9 888 261 864.9c-27.2-10.7-47.4-23.2-60-37.3-10.4-11.7-15.1-23.7-15.1-38.9 0-19 7.4-40.9 21.4-63.6 15.9-25.6 39.5-50.8 68.2-72.8 31-23.7 67.7-43.3 106.2-56.8 42.4-14.8 86.3-22.3 130.6-22.3m0-60c-213.4 0-386.4 152.1-386.4 275.5s173 171.5 386.4 171.5 386.4-48.1 386.4-171.5-172.9-275.5-386.4-275.5z" fill="#45484C"></path></g></svg>
        Personal Style
    </div>
</div>
            <div class="clear-filter" id="clearFilter">✕ Clear</div>
        </div>

        <div class="input-container">
            <div class="style-progress">
                <div class="style-progress-bar" id="styleProgressBar"></div>
            </div>
            <div class="style-progress-text" id="styleProgressText">0/10,000</div>
            <div class="circle-btn loading-pulse" id="customInputBtn">
                <span class="icon"></span>
                <div class="input-wrapper">
                    <input type="text" class="custom-input" id="customInput" placeholder="Enter #feedback or your style...">
                </div>
            </div>
        </div>

        <button class="refresh-btn" id="refreshBtn">Refresh</button>

        <div id="tweets-container">
            <div class="no-tweets">
                Write a comment on Twitter/X with the extension enabled to see generated tweets here.
            </div>
        </div>

        <div class="schedule-dialog" id="schedule-dialog">
            <h3>Schedule the tweet</h3>
            <div class="datetime-group">
                <label for="scheduleDate">📅 Date</label>
                <input type="date" id="scheduleDate" class="datetime-input">
            </div>
            <div class="datetime-group">
                <label for="scheduleTime">⏰ Time</label>
                <input type="time" id="scheduleTime" class="datetime-input">
            </div>
            <div class="button-group">
                <button class="cancel" onclick="closeScheduleDialog()">Cancel</button>
                <button onclick="confirmSchedule()">Schedule</button>
            </div>
        </div>

        <div class="notification" id="notification">
            <div id="notificationMessage"></div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCh0EeCbrm-LzHYOJAYTuQlJJzTFBs-xjo",
            authDomain: "ropainx-b13da.firebaseapp.com",
            projectId: "ropainx-b13da",
            storageBucket: "ropainx-b13da.firebasestorage.app",
            messagingSenderId: "293729340264",
            appId: "1:293729340264:web:89bbcdc6197a05520b64dd",
            measurementId: "G-H3T6EF9E4H"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);

        // Update user profile
        onAuthStateChanged(window.auth, (user) => {
            if (user) {
                document.getElementById('userName').textContent = user.displayName || 'User';
                // document.getElementById('userHandle').textContent = `@${user.uid || 'user'}`;
                document.getElementById('userHandle').textContent = `@${user.email?.split('@')[0] || 'user'}`;
                document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/40';
                document.getElementById('dropdownUserName').textContent = user.displayName || 'User';
                document.getElementById('dropdownUserHandle').textContent = `@${user.email?.split('@')[0] || 'user'}`;
            } else {
               window.location.href = '/auth.html';
            }
        });
    </script>

    <!-- DOMPurify for secure HTML display -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3.11.0/dist/email.min.js"></script>
    <script>
        emailjs.init('xCP3VGGrqcLeoxGXX');

        let isLoading = false;
        let lastUpdateTime = 0;
        let selectedFilter = null;
        let isEditing = false;
        let lastRefreshAttempt = 0;
        const MIN_REFRESH_INTERVAL = 10000;
        let tweetsDataCache = [];
        let lastETag = null;
        let styleProgress = 0;
        let scheduledTweets = [];
        let selectedMedia = new Map();
        let tweetSchedules = new Map();
        let currentTweetId = null;
        let currentTweetIndex = null;
 const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

  // Définir l'URL cible en fonction
  const BASE_URL = isLocal
      ? "http://localhost:3000"   // ton serveur local (adapté au port que tu utilises)
      : "https://https://ropainx.onrender.com"; // ton serveur Render

        function checkAuth() {
            const idToken = localStorage.getItem('idToken');
            const uid = localStorage.getItem('uid');
            if (!idToken || !uid || (window.__USER_UID__ && uid !== window.__USER_UID__)) {
               window.location.href = '/auth.html';
                return false;
            }
            return true;
        }

      async function refreshIdToken() {
  try {
    const user = auth.currentUser;
    if (user) {
      const idToken = await user.getIdToken(true);  // Force refresh
      localStorage.setItem('idToken', idToken);
      console.log('🔄 [DEBUG] Token rafraîchi');
    }
  } catch (error) {
    console.error('❌ [DEBUG] Erreur refresh token:', error);
  }
}

// Call on load and every 30min
setInterval(refreshIdToken, 1800000);
refreshIdToken();

        async function handleLogout() {
            try {
                await window.auth.signOut();
                localStorage.removeItem('idToken');
                localStorage.removeItem('uid');
               window.location.href = '/auth.html';
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout error.', 'error');
            }
        }

        function formatTweetText(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            let formatted = text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
            return DOMPurify.sanitize(formatted, { ALLOWED_TAGS: ['a'], ALLOWED_ATTR: ['href', 'target'] });
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('en-US', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Africa/Lagos'
            }).format(date);
        }

        function updateStyleProgress() {
            const maxProgress = 10000;
            styleProgress = Math.min(styleProgress, maxProgress);
            const progressPercentage = (styleProgress / maxProgress) * 100;
            document.getElementById('styleProgressBar').style.width = `${progressPercentage}%`;
            document.getElementById('styleProgressText').textContent = `${styleProgress}/${maxProgress}`;
        }

        async function fetchUserStats() {
            try {
                const response = await fetch(`${BASE_URL}/api/user-stats`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('idToken')}` }
                });
                const data = await response.json();
                if (data.success && data.data) {
                    styleProgress = data.data.styleProgress || 0;
                    updateStyleProgress();
                }
            } catch (error) {
                console.error('Stats fetch error:', error);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            if (messageElement) {
                messageElement.textContent = message;
                notification.className = `notification ${type} show`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }
        }

        async function checkServerStatus() {
            const maxRetries = 3;
            let retries = 0;
            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${BASE_URL}/health`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('idToken')}` },
                        signal: AbortSignal.timeout(5000)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('status').textContent = `Server connected ✓ (v${data.version || '1.0'})`;
                        document.getElementById('status').className = 'status online';
                        return true;
                    }
                    throw new Error('Server unreachable');
                } catch (error) {
                    retries++;
                    if (retries === maxRetries) {
                        document.getElementById('status').textContent = 'Server disconnected ✗';
                        document.getElementById('status').className = 'status offline';
                        showNotification('Unable to connect to server.');
                        return false;
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        async function fetchWithRetry(url, options = {}, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      options.headers = { ...options.headers, 'Authorization': `Bearer ${localStorage.getItem('idToken')}` };
      const response = await fetch(url, options);
      if (response.status === 401) {
        await refreshIdToken();
        continue;
      }
      return response;
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(r => setTimeout(r, 1000));
    }
  }
}
// Use: const response = await fetchWithRetry(`${BASE_URL}/api/tweets-history`, { headers: { 'If-None-Match': lastETag } });

        async function refreshIdToken() {
  try {
    const user = auth.currentUser;
    if (user) {
      const idToken = await user.getIdToken(true);  // Force refresh
      localStorage.setItem('idToken', idToken);
      console.log('🔄 [DEBUG] Token rafraîchi');
    }
  } catch (error) {
    console.error('❌ [DEBUG] Erreur refresh token:', error);
  }
}

// Call on load and every 30min
setInterval(refreshIdToken, 1800000);
refreshIdToken();

        async function loadTweets(isManual = false) {
            if (!checkAuth()) return;
            if (isLoading || isEditing || (isManual && Date.now() - lastRefreshAttempt < MIN_REFRESH_INTERVAL)) return;

            isLoading = true;
            lastRefreshAttempt = Date.now();
            const container = document.getElementById('tweets-container');
            const refreshBtn = document.getElementById('refreshBtn');

            if (isManual) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            document.querySelectorAll('.tweet-content[data-dirty="true"]').forEach(textarea => {
                const [_, tweetId, tweetIndex] = textarea.id.split('_');
                saveTweetEdit(tweetId, parseInt(tweetIndex), textarea.value.trim());
            });

            const maxRetries = 3;
            let retryCount = 0;
document.addEventListener('DOMContentLoaded', () => {
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      console.log("✅ Utilisateur connecté:", user.email);

      // Stocker / rafraîchir le token Firebase
      const idToken = await user.getIdToken(true);
      localStorage.setItem('idToken', idToken);

      // Charger le dashboard
      initDashboard();

    } else {
      console.log("❌ Aucun utilisateur connecté, redirection vers login");
      window.location.href = '/auth.html'; // 👉 crée une page simple avec boutons Google/Twitter
    }
  });
});
            async function attemptFetch() {
                try {
                    const headers = {
                        'Authorization': `Bearer ${localStorage.getItem('idToken')}`,
                        ...(lastETag ? { 'If-None-Match': lastETag } : {})
                    };
                    const response = await fetchWithRetry(`${BASE_URL}/api/tweets-history`, { headers, signal: AbortSignal.timeout(5000) });

                    if (response.status === 401) {
                       window.location.href = '/auth.html';
                        return null;
                    }
                    if (response.status === 304) {
                        console.log('ℹ️ Data unchanged');
                        return null;
                    }
                    if (!response.ok) throw new Error(`Network error: ${response.status}`);

                    const data = await response.json();
                    lastETag = response.headers.get('ETag');
                    return data;
                } catch (error) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Attempt ${retryCount}/${maxRetries} failed, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        return attemptFetch();
                    }
                    throw error;
                }
            }

            try {
                const data = await attemptFetch();
                if (data && data.success && data.data && data.data.length > 0) {
                    tweetsDataCache = data.data;
                    await loadScheduledTweets();
                    displayTweets(tweetsDataCache);
                    lastUpdateTime = Date.now();
                } else if (!data) {
                    return;
                } else {
                    tweetsDataCache = [];
                    container.innerHTML = '<div class="no-tweets">No tweets generated.<br>Use the extension on Twitter/X!</div>';
                }
            } catch (error) {
                console.error('Tweet loading error:', error);
                container.innerHTML = '<div class="no-tweets">Tweet loading error.<br>Check if the server is working.</div>';
                showNotification('Tweet loading error.');
            } finally {
                isLoading = false;
                if (isManual) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh';
                }
            }
        }

        function displayTweets(tweetsData) {
            const container = document.getElementById('tweets-container');
            if (!tweetsData || tweetsData.length === 0) {
                container.innerHTML = '<div class="no-tweets">No tweets generated</div>';
                return;
            }

            let allTweets = [];
            tweetsData.forEach(tweetGroup => {
                if (!tweetGroup.generatedTweets || tweetGroup.generatedTweets.length === 0) return;

                const filteredTweets = selectedFilter
                    ? tweetGroup.generatedTweets.map((tweet, index) => ({
                          tweet,
                          index,
                          mode: (tweetGroup.modesUsed && tweetGroup.modesUsed[index]) || 'unknown'
                      })).filter(item => item.mode === selectedFilter)
                    : tweetGroup.generatedTweets.map((tweet, index) => ({
                          tweet,
                          index,
                          mode: (tweetGroup.modesUsed && tweetGroup.modesUsed[index]) || 'unknown'
                      }));

                filteredTweets.forEach(item => {
                    allTweets.push({ ...item, tweetGroup });
                });
            });

            if (allTweets.length === 0) {
                container.innerHTML = '<div class="no-tweets">No tweets match the filter</div>';
                return;
            }

            let html = '<div class="tweets-grid">';
            const userPhoto = document.getElementById('userPhoto').src;

            allTweets.forEach(({ tweet, index, mode, tweetGroup }) => {
                const tweetId = `tweet_${tweetGroup.id}_${index}`;
                const cleanMode = mode === 'style-personnel' ? 'Personal Style' : mode.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const timestamp = formatDate(new Date(tweetGroup.timestamp));
                const scheduleKey = `${tweetGroup.id}_${index}`;
                const tweetInfo = scheduledTweets.find(t => `${t.tweetId}_${t.tweetIndex}` === scheduleKey);
                let statusText, statusClass, scheduleDate;

                if (tweetInfo) {
                    switch(tweetInfo.status) {
                        case 'scheduled':
                            statusClass = 'status-scheduled';
                            statusText = tweetInfo.datetime <= new Date() ? 'In progress...' : 'Scheduled';
                            scheduleDate = formatDate(new Date(tweetInfo.datetime));
                            break;
                        case 'published':
                            statusClass = 'status-published';
                            statusText = 'Published';
                            break;
                        case 'failed':
                            statusClass = 'status-failed';
                            statusText = 'Failed';
                            break;
                        default:
                            statusClass = '';
                            statusText = '';
                    }
                } else {
                    statusClass = '';
                    statusText = '';
                }

                html += `
                    <div class="tweet-item" id="${tweetId}_container">
                        <div class="badge-timestamp">
                            <div class="mode-badge">${cleanMode}</div>
                            <div class="timestamp">
                                ${timestamp}
                                ${statusText ? `<span class="status-indicator ${statusClass}"></span><span style="font-size: 10px; color: #888;">${statusText}${scheduleDate ? ` on ${scheduleDate}` : ''}</span>` : ''}
                            </div>
                        </div>
                        <div class="tweet-post" onclick="toggleEdit('${tweetId}')">
                            <img src="${userPhoto}" alt="Profile">
                            <div class="tweet-post-content">${formatTweetText(tweet)}</div>
                        </div>
                        <textarea class="tweet-content" id="${tweetId}" placeholder="Your tweet..." data-dirty="false">${tweet}</textarea>
                        <div class="media-upload-container" id="media-upload-${tweetId}" style="display: none;">
                            <div class="media-upload" onclick="document.getElementById('media-input-${tweetId}').click()">
                                <input type="file" id="media-input-${tweetId}" accept="image/jpeg,image/png,video/mp4" multiple>
                                <div>📷 Add media (images/videos)</div>
                                <div style="font-size: 10px; color: #666; margin-top: 5px;">
                                    Click to select files (max 4)
                                </div>
                            </div>
                            <div class="media-preview" id="media-preview-${tweetId}"></div>
                        </div>
                        <div class="tweet-meta">
                            <span id="count_${tweetId}">${tweet.length}/280</span>
                            <div class="button-group">
                                <button class="copy-btn" onclick="copyTweet('${tweetId}')">
                                 <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M20.9983 10C20.9862 7.82497 20.8897 6.64706 20.1213 5.87868C19.2426 5 17.8284 5 15 5H12C9.17157 5 7.75736 5 6.87868 5.87868C6 6.75736 6 8.17157 6 11V16C6 18.8284 6 20.2426 6.87868 21.1213C7.75736 22 9.17157 22 12 22H15C17.8284 22 19.2426 22 20.1213 21.1213C21 20.2426 21 18.8284 21 16V15" stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path> <path d="M3 10V16C3 17.6569 4.34315 19 6 19M18 5C18 3.34315 16.6569 2 15 2H11C7.22876 2 5.34315 2 4.17157 3.17157C3.51839 3.82475 3.22937 4.69989 3.10149 6" stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path> </g></svg>


                                </button>
                                <button class="regen-btn" onclick="regenerateTweet('${tweetGroup.id}', ${index}, '${mode}')">
<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M12 3L13.4302 8.31181C13.6047 8.96 13.692 9.28409 13.8642 9.54905C14.0166 9.78349 14.2165 9.98336 14.451 10.1358C14.7159 10.308 15.04 10.3953 15.6882 10.5698L21 12L15.6882 13.4302C15.04 13.6047 14.7159 13.692 14.451 13.8642C14.2165 14.0166 14.0166 14.2165 13.8642 14.451C13.692 14.7159 13.6047 15.04 13.4302 15.6882L12 21L10.5698 15.6882C10.3953 15.04 10.308 14.7159 10.1358 14.451C9.98336 14.2165 9.78349 14.0166 9.54905 13.8642C9.28409 13.692 8.96 13.6047 8.31181 13.4302L3 12L8.31181 10.5698C8.96 10.3953 9.28409 10.308 9.54905 10.1358C9.78349 9.98336 9.98336 9.78349 10.1358 9.54905C10.308 9.28409 10.3953 8.96 10.5698 8.31181L12 3Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                                </button>
                                <button class="schedule-btn" onclick="openScheduleDialog('${tweetGroup.id}', ${index})">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18 2V4M6 2V4" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M11.5 18L12.5 18M11.5 18C11.5 18.5523 11.0523 19 10.5 19C9.94771 19 9.5 18.5523 9.5 18M11.5 18C11.5 17.4477 11.0523 17 10.5 17C9.94771 17 9.5 17.4477 9.5 18M11.5 18L9.5 18" stroke="#000000" stroke-width="1.5" stroke-linejoin="round"></path> <path d="M20.5 7.00001L3.49998 7.00001" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path d="M8 6C8 5.06812 8 4.60218 8.15224 4.23463C8.35523 3.74458 8.74458 3.35523 9.23463 3.15224C9.60218 3 10.0681 3 11 3H13C13.9319 3 14.3978 3 14.7654 3.15224C15.2554 3.35523 15.6448 3.74458 15.8478 4.23463C16 4.60218 16 5.06812 16 6V7C16 7.93188 16 8.39782 15.8478 8.76537C15.6448 9.25542 15.2554 9.64477 14.7654 9.84776C14.3978 10 13.9319 10 13 10H11C10.0681 10 9.60218 10 9.23463 9.84776C8.74458 9.64477 8.35523 9.25542 8.15224 8.76537C8 8.39782 8 7.93188 8 7V6Z" stroke="#000000" stroke-width="1.5"></path> <path d="M21.5 11.5C21.5 10.6716 20.8284 10 20 10H4C3.17157 10 2.5 10.6716 2.5 11.5V17C2.5 19.7614 4.73858 22 7.5 22H16.5C19.2614 22 21.5 19.7614 21.5 17V11.5Z" stroke="#000000" stroke-width="1.5"></path> </g></svg>
                                </button>
                                <button class="media-btn" onclick="toggleMediaUpload('${tweetId}')">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M13.5 9C13.5 8.17157 12.8284 7.5 12 7.5C11.1716 7.5 10.5 8.17157 10.5 9C10.5 9.82843 11.1716 10.5 12 10.5C12.8284 10.5 13.5 9.82843 13.5 9Z" fill="#000000"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M7.25 3C4.35051 3 2 5.35051 2 8.25V15.75C2 18.6495 4.35051 21 7.25 21H16.75C19.6495 21 22 18.6495 22 15.75V8.25C22 5.35051 19.6495 3 16.75 3H7.25ZM3.5 8.25C3.5 6.17893 5.17893 4.5 7.25 4.5H16.75C18.8211 4.5 20.5 6.17893 20.5 8.25V15.75C20.5 17.8211 18.8211 19.5 16.75 19.5H7.25C5.17893 19.5 3.5 17.8211 3.5 15.75V8.25Z" fill="#000000"></path> </g></svg>
                                </button>
                                <button class="delete-btn" onclick="deleteTweet('${tweetGroup.id}', ${index})">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M4 7H20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M6 10L7.70141 19.3578C7.87432 20.3088 8.70258 21 9.66915 21H14.3308C15.2974 21 16.1257 20.3087 16.2986 19.3578L18 10" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                                </button>
                            </div>
                        </div>
                    </div>`;
            });

            html += '</div>';
            container.innerHTML = html;

            // Add event listeners for textareas
            document.querySelectorAll('.tweet-content').forEach(textarea => {
                textarea.addEventListener('input', updateCharCount);
                textarea.addEventListener('focus', () => { isEditing = true; });
                textarea.addEventListener('blur', () => {
                    isEditing = false;
                    const [_, tweetId, tweetIndex] = textarea.id.split('_');
                    if (textarea.dataset.dirty === 'true') {
                        saveTweetEdit(tweetId, parseInt(tweetIndex), textarea.value.trim());
                    }
                });
            });

            // Add event listeners for media inputs
            document.querySelectorAll('.media-upload input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const tweetId = e.target.id.replace('media-input-', '');
                    const [_, tweetGroupId, tweetIndex] = tweetId.split('_');
                    const scheduleKey = `${tweetGroupId}_${tweetIndex}`;
                    let mediaList = selectedMedia.get(scheduleKey) || [];
                    if (mediaList.length >= 4) {
                        showNotification('Maximum 4 media per tweet.');
                        return;
                    }
                    const newFiles = Array.from(e.target.files);
                    if (mediaList.length + newFiles.length > 4) {
                        showNotification(`Maximum 4 media. ${4 - mediaList.length} file(s) remaining.`);
                        return;
                    }
                    newFiles.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const mediaItem = {
                                id: Date.now() + Math.random(),
                                file,
                                url: e.target.result,
                                type: file.type.startsWith('image/') ? 'image' : 'video',
                                mimetype: file.type
                            };
                            mediaList.push(mediaItem);
                            selectedMedia.set(scheduleKey, mediaList);
                            renderMediaPreview(tweetId, scheduleKey);
                        };
                        reader.readAsDataURL(file);
                    });
                    e.target.value = '';
                });
            });

            // Render media previews
            document.querySelectorAll('.media-preview').forEach(preview => {
                const tweetId = preview.id.replace('media-preview-', '');
                const scheduleKey = tweetId.replace('tweet_', '');
                renderMediaPreview(tweetId, scheduleKey);
            });
        }

        function toggleMediaUpload(tweetId) {
            const mediaContainer = document.getElementById(`media-upload-${tweetId}`);
            mediaContainer.style.display = mediaContainer.style.display === 'block' ? 'none' : 'block';
            if (mediaContainer.style.display === 'block') {
                const scheduleKey = tweetId.replace('tweet_', '');
                renderMediaPreview(tweetId, scheduleKey);
            }
        }

        function renderMediaPreview(tweetId, scheduleKey) {
            const mediaPreview = document.getElementById(`media-preview-${tweetId}`);
            if (!mediaPreview) return;

            const clientMedia = selectedMedia.get(scheduleKey) || [];
            const serverMedia = scheduledTweets.find(t => `${t.tweetId}_${t.tweetIndex}` === scheduleKey)?.media || [];
            const mergedMedia = [
                ...serverMedia.filter(m => m && m.filename && m.mimetype).map(m => ({
                    id: m.id || (m.filename + Math.random()),
                    url: m.url || `${BASE_URL}/uploads/${m.filename}`,
                    type: m.type || (m.mimetype && m.mimetype.startsWith('image/') ? 'image' : 'video'),
                    server: true,
                    mimetype: m.mimetype
                })),
                ...clientMedia.filter(m => !m.server)
            ].slice(0, 4);

            mediaPreview.innerHTML = mergedMedia.map(media => `
                <div class="media-item" data-media-id="${media.id}">
                    ${media.type === 'image'
                        ? `<img src="${media.url}" alt="Preview">`
                        : `<video src="${media.url}" controls style="width: 100%; height: 80px;"></video>`
                    }
                    ${!media.server ? `<button class="media-remove" data-schedule-key="${scheduleKey}" data-media-id="${media.id}">×</button>` : ''}
                </div>
            `).join('');

            mediaPreview.querySelectorAll('.media-remove').forEach(button => {
                button.addEventListener('click', () => {
                    const scheduleKey = button.dataset.scheduleKey;
                    const mediaId = parseFloat(button.dataset.mediaId);
                    removeMedia(scheduleKey, mediaId, button);
                });
            });
        }

        function removeMedia(scheduleKey, mediaId, button) {
            button.disabled = true;
            button.style.background = 'rgba(0,0,0,0.05)';
            let mediaList = selectedMedia.get(scheduleKey) || [];
            const originalLength = mediaList.length;
            mediaList = mediaList.filter(media => media.id !== mediaId);
            if (mediaList.length < originalLength) {
                selectedMedia.set(scheduleKey, mediaList);
                const tweetId = `tweet_${scheduleKey}`;
                renderMediaPreview(tweetId, scheduleKey);
                showNotification('Media removed.');
            } else {
                showNotification('Error removing media.', 'error');
            }
            button.disabled = false;
            button.style.background = 'rgba(0,0,0,0.1)';
        }
         function toggleEdit(tweetId) {
            const textarea = document.getElementById(tweetId);
            const tweetPost = textarea.closest('.tweet-item').querySelector('.tweet-post');

            if (textarea.style.display === 'none' || !textarea.style.display) {
                textarea.style.display = 'block';
                tweetPost.style.display = 'none';
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            } else {
                textarea.style.display = 'none';
                tweetPost.style.display = 'flex';

                const [_, tweetGroupId, tweetIndex] = tweetId.split('_');
                if (textarea.dataset.dirty === 'true') {
                    saveTweetEdit(tweetGroupId, parseInt(tweetIndex), textarea.value.trim());
                }
            }
        }

        async function deleteTweet(tweetId, tweetIndex) {
            if (!checkAuth()) return;
            if (!confirm('Do you really want to delete this tweet?')) return;

            const tweetElement = document.getElementById(`tweet_${tweetId}_${tweetIndex}_container`);
            const deleteBtn = tweetElement.querySelector('.delete-btn');
            const originalContent = deleteBtn.innerHTML;

            deleteBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';
            deleteBtn.disabled = true;

            const scheduleKey = `${tweetId}_${tweetIndex}`;
            const tweetInfo = scheduledTweets.find(t => `${t.tweetId}_${t.tweetIndex}` === scheduleKey);

            const maxRetries = 3;
            let retryCount = 0;

            async function attemptDelete() {
                try {
                    if (tweetInfo) {
                        const response = await fetchWithRetry(`${BASE_URL}/api/tweets/${tweetInfo.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                            },
                            signal: AbortSignal.timeout(5000)
                        });
                        if (!response.ok) {
                            const result = await response.json();
                            throw new Error(result.error || `Network error: ${response.status}`);
                        }
                        scheduledTweets = scheduledTweets.filter(t => `${t.tweetId}_${t.tweetIndex}` !== scheduleKey);
                        tweetSchedules.delete(scheduleKey);
                        selectedMedia.delete(scheduleKey);
                    }

                    const response = await fetch(`${BASE_URL}/api/delete-tweet`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                        },
                        body: JSON.stringify({ tweetId, tweetIndex }),
                        signal: AbortSignal.timeout(5000)
                    });

                    if (response.status === 401) {
                       window.location.href = '/auth.html';
                        return;
                    }

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || `Network error: ${response.status}`);
                    }

                    if (result.success) {
                        tweetElement.remove();
                        const group = tweetsDataCache.find(g => g.id === tweetId);
                        if (group) {
                            group.generatedTweets.splice(tweetIndex, 1);
                            if (group.modesUsed) group.modesUsed.splice(tweetIndex, 1);
                            group.lastModified = result.data?.lastModified;
                            if (group.generatedTweets.length === 0) {
                                tweetsDataCache = tweetsDataCache.filter(g => g.id !== tweetId);
                            }
                        }
                        displayTweets(tweetsDataCache);
                        showNotification('Tweet deleted successfully!', 'success');
                        if (!document.querySelector('.tweet-item')) {
                            document.getElementById('tweets-container').innerHTML = '<div class="no-tweets">No tweets generated</div>';
                        }
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                } catch (error) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Attempt ${retryCount}/${maxRetries} failed for deletion, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        return attemptDelete();
                    }
                    throw error;
                }
            }

            try {
                await attemptDelete();
            } catch (error) {
                console.error('Tweet deletion error:', error);
                showNotification(`Error: ${error.message}.`);
                deleteBtn.innerHTML = originalContent;
                deleteBtn.disabled = false;
            }
        }

        function updateCharCount(event) {
            const textarea = event.target;
            const countElement = document.getElementById(`count_${textarea.id}`);
            if (countElement) {
                const length = textarea.value.length;
                countElement.textContent = `${length}/280`;
                countElement.style.color = length > 280 ? '#dc3545' : length > 250 ? '#ffc107' : '#6c757d';
                textarea.dataset.dirty = 'true';

                // Update tweet display
                const tweetElement = textarea.closest('.tweet-item');
                const postContent = tweetElement.querySelector('.tweet-post-content');
                postContent.innerHTML = formatTweetText(textarea.value);
            }
        }

        async function saveTweetEdit(tweetId, tweetIndex, newText) {
            if (!checkAuth()) return;
            if (!newText) {
                showNotification('Tweet cannot be empty.');
                return;
            }
            if (newText.length > 280) {
                showNotification('Tweet exceeds 280 characters.');
                return;
            }

            const textarea = document.getElementById(`tweet_${tweetId}_${tweetIndex}`);
            const maxRetries = 3;
            let retryCount = 0;

            async function attemptSave() {
                try {
                    textarea.disabled = true;
                    textarea.classList.add('loading-pulse');

                    const response = await fetch(`${BASE_URL}/api/edit-tweet`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                        },
                        body: JSON.stringify({ tweetId, tweetIndex, newText }),
                        signal: AbortSignal.timeout(5000)
                    });

                    if (response.status === 401) {
                       window.location.href = '/auth.html';
                        return;
                    }

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `Network error: ${response.status}`);

                    if (result.success) {
                        textarea.dataset.dirty = 'false';
                        updateCharCount({ target: textarea });
                        styleProgress = result.data.styleProgress || styleProgress;
                        updateStyleProgress();
                        showNotification('Tweet modified successfully!', 'success');

                        const group = tweetsDataCache.find(g => g.id === tweetId);
                        if (group) {
                            group.generatedTweets[tweetIndex] = newText;
                            group.lastModified = result.data?.lastModified;
                        }
                        const scheduleKey = `${tweetId}_${tweetIndex}`;
                        const tweetInfo = scheduledTweets.find(t => `${t.tweetId}_${t.tweetIndex}` === scheduleKey);
                        if (tweetInfo) {
                            tweetInfo.content = newText;
                        }
                        displayTweets(tweetsDataCache);
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                } catch (error) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Attempt ${retryCount}/${maxRetries} failed for save, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        return attemptSave();
                    }
                    throw error;
                }
            }

            try {
                await attemptSave();
            } catch (error) {
                console.error('Tweet modification error:', error);
                showNotification(`Error: ${error.message}.`);
            } finally {
                textarea.disabled = false;
                textarea.classList.remove('loading-pulse');
            }
        }

        async function copyTweet(tweetId) {
            const textarea = document.getElementById(tweetId);
            const tweetElement = textarea.closest('.tweet-item');
            const copyBtn = tweetElement.querySelector('.copy-btn');
            const originalContent = copyBtn.innerHTML;

            try {
                await navigator.clipboard.writeText(textarea.value);
                copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"></polyline></svg>';
                copyBtn.classList.add('copied');
                tweetElement.style.background = 'linear-gradient(145deg, #f8f9fa, #e9ecef)';
                tweetElement.style.borderColor = '#ced4da';
                showNotification('Tweet copied!', 'success');

                setTimeout(() => {
                    copyBtn.innerHTML = originalContent;
                    copyBtn.classList.remove('copied');
                    tweetElement.style.background = 'linear-gradient(145deg, #ffffff, #f8f9fa)';
                    tweetElement.style.borderColor = '#dee2e6';
                }, 2000);
            } catch (error) {
                console.error('Copy error:', error);
                showNotification('Copy error.', 'error');
                copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                setTimeout(() => copyBtn.innerHTML = originalContent, 2000);
            }
        }

        async function regenerateTweet(tweetId, tweetIndex, mode) {
            if (!checkAuth()) return;

            const tweetElement = document.getElementById(`tweet_${tweetId}_${tweetIndex}_container`);
            const regenBtn = tweetElement.querySelector('.regen-btn');
            const originalContent = regenBtn.innerHTML;

            regenBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';
            regenBtn.disabled = true;

            const maxRetries = 3;
            let retryCount = 0;

            async function attemptRegenerate() {
                try {
                    const response = await fetch(`${BASE_URL}/api/regenerate-tweet`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                        },
                        body: JSON.stringify({ tweetId, tweetIndex, mode }),
                        signal: AbortSignal.timeout(5000)
                    });

                    if (response.status === 401) {
                       window.location.href = '/auth.html';
                        return;
                    }

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Network error');

                    if (result.success && result.data) {
                        const textarea = document.getElementById(`tweet_${tweetId}_${tweetIndex}`);
                        textarea.value = result.data.tweet;
                        textarea.dataset.dirty = 'false';
                        updateCharCount({ target: textarea });

                        regenBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"></polyline></svg>';
                        regenBtn.classList.add('regenerated');

                        setTimeout(() => {
                            regenBtn.innerHTML = originalContent;
                            regenBtn.classList.remove('regenerated');
                            regenBtn.disabled = false;
                        }, 2000);

                        showNotification('Tweet regenerated successfully!', 'success');

                        const group = tweetsDataCache.find(g => g.id === tweetId);
                        if (group) {
                            group.generatedTweets[tweetIndex] = result.data.tweet;
                            if (group.modesUsed) group.modesUsed[tweetIndex] = mode;
                            group.lastModified = result.data?.lastModified;
                        }
                        displayTweets(tweetsDataCache);
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                } catch (error) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Attempt ${retryCount}/${maxRetries} failed for regeneration, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        return attemptRegenerate();
                    }
                    throw error;
                }
            }

            try {
                await attemptRegenerate();
            } catch (error) {
                console.error('Regeneration error:', error);
                showNotification(`Error: ${error.message}.`, 'error');
                regenBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                setTimeout(() => {
                    regenBtn.innerHTML = originalContent;
                    regenBtn.disabled = false;
                }, 2000);
            }
        }

        function openScheduleDialog(tweetId, tweetIndex) {
            currentTweetId = tweetId;
            currentTweetIndex = tweetIndex;
            const dialog = document.getElementById('schedule-dialog');
            const scheduleDate = document.getElementById('scheduleDate');
            const scheduleTime = document.getElementById('scheduleTime');
            const now = new Date();
            now.setMinutes(0, 0, 0);
            scheduleDate.min = now.toISOString().split('T')[0];
            scheduleDate.value = now.toISOString().split('T')[0];
            now.setHours(now.getHours() + 1);
            scheduleTime.value = now.toTimeString().slice(0, 5);
            dialog.style.display = 'flex';
            scheduleDate.focus();
        }

        function closeScheduleDialog() {
            document.getElementById('schedule-dialog').style.display = 'none';
            currentTweetId = null;
            currentTweetIndex = null;
        }
async function confirmSchedule() {
    console.log('🎯 [DEBUG] confirmSchedule() appelée');

    if (!currentTweetId || currentTweetIndex === null) {
        console.log('❌ [DEBUG] Aucun tweet sélectionné:', { currentTweetId, currentTweetIndex });
        showNotification('No tweet selected.', 'error');
        return;
    }

    console.log('✅ [DEBUG] Tweet sélectionné:', { currentTweetId, currentTweetIndex });

    const scheduleDate = document.getElementById('scheduleDate');
    const scheduleTime = document.getElementById('scheduleTime');
    const content = document.getElementById(`tweet_${currentTweetId}_${currentTweetIndex}`).value.trim();
    const scheduleKey = `${currentTweetId}_${currentTweetIndex}`;
    const tweetElement = document.getElementById(`tweet_${currentTweetId}_${currentTweetIndex}_container`);
    const scheduleBtn = tweetElement.querySelector('.schedule-btn');
    const originalContent = scheduleBtn.innerHTML;

    console.log('📝 [DEBUG] Contenu du tweet:', { content, length: content.length });

    // Validations basiques
    if (!content) {
        console.log('❌ [DEBUG] Tweet vide');
        showNotification('Tweet cannot be empty.', 'error');
        return;
    }
    if (content.length > 280) {
        console.log('❌ [DEBUG] Tweet trop long:', content.length);
        showNotification('Tweet exceeds 280 characters.', 'error');
        return;
    }
    if (!scheduleDate.value || !scheduleTime.value) {
        console.log('❌ [DEBUG] Date/heure manquante:', { date: scheduleDate.value, time: scheduleTime.value });
        showNotification('Please select date and time.', 'error');
        return;
    }

    const datetime = `${scheduleDate.value}T${scheduleTime.value}:00`;
    const scheduleDateTime = new Date(datetime);
    const now = new Date();

    console.log('⏰ [DEBUG] Validation date:', {
        datetime,
        scheduleDateTime: scheduleDateTime.toISOString(),
        now: now.toISOString(),
        isFuture: scheduleDateTime > now
    });

    if (scheduleDateTime <= now) {
        console.log('❌ [DEBUG] Date dans le passé');
        showNotification('Date must be in the future.', 'error');
        return;
    }

    // UI feedback de chargement
    scheduleBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';
    scheduleBtn.disabled = true;

    const maxRetries = 3;
    let retryCount = 0;

    async function attemptSchedule() {
        console.log(`🔄 [DEBUG] Tentative de scheduling ${retryCount + 1}/${maxRetries}`);

        try {
            const formData = new FormData();
            formData.append('content', content);
            formData.append('datetime', datetime);
            formData.append('tweetId', currentTweetId);
            formData.append('tweetIndex', currentTweetIndex);

            const mediaItems = selectedMedia.get(scheduleKey) || [];
            console.log('🖼️ [DEBUG] Médias attachés:', mediaItems.length);

            mediaItems.forEach((media, index) => {
                if (media.file && media.mimetype) {
                    console.log(`📎 [DEBUG] Média ${index}:`, { name: media.file.name, type: media.mimetype });
                    formData.append('media', media.file, media.file.name);
                }
            });

            console.log('📡 [DEBUG] Envoi requête vers /api/schedule-tweet...');

            const response = await fetch(`${BASE_URL}/api/schedule-tweet`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                },
                body: formData,
                signal: AbortSignal.timeout(15000) // Augmenté à 15s
            });

            console.log('📥 [DEBUG] Réponse reçue:', {
                status: response.status,
                ok: response.ok,
                statusText: response.statusText
            });

            if (response.status === 401) {
                console.log('🔒 [DEBUG] Token Firebase expiré, redirection auth');
               window.location.href = '/auth.html';
                return;
            }

            const result = await response.json();
            console.log('📋 [DEBUG] Résultat parsing:', result);

            if (!response.ok) {
                console.log('❌ [DEBUG] Erreur serveur:', result.error);
                throw new Error(result.error || `Network error: ${response.status}`);
            }

            if (result.success) {
                console.log('🎉 [DEBUG] Scheduling réussi !');

                // Mise à jour des données locales
                tweetSchedules.set(scheduleKey, scheduleDateTime.toISOString());
                scheduledTweets = scheduledTweets.filter(t => `${t.tweetId}_${t.tweetIndex}` !== scheduleKey);
                scheduledTweets.push({
                    id: result.tweet.id,
                    content,
                    datetime: scheduleDateTime,
                    media: result.tweet.media || [],
                    status: 'scheduled',
                    tweetId: currentTweetId,
                    tweetIndex: currentTweetIndex,
                    lastModified: result.tweet.lastModified,
                    createdAt: new Date(result.tweet.createdAt)
                });

                // Mise à jour UI
                const timestampElement = tweetElement.querySelector('.timestamp');
                timestampElement.innerHTML = `
                    ${formatDate(new Date(result.tweet.createdAt))}
                    <span class="status-indicator status-scheduled"></span>
                    <span style="font-size: 10px; color: #888;">Scheduled on ${formatDate(scheduleDateTime)}</span>
                `;

                // Reset des médias
                selectedMedia.set(scheduleKey, []);
                renderMediaPreview(`tweet_${currentTweetId}_${currentTweetIndex}`, scheduleKey);

                // Feedback visuel succès
                scheduleBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"></polyline></svg>';
                scheduleBtn.classList.add('scheduled');
                showNotification('Tweet scheduled successfully!', 'success');

                setTimeout(() => {
                    scheduleBtn.innerHTML = originalContent;
                    scheduleBtn.classList.remove('scheduled');
                    scheduleBtn.disabled = false;
                }, 2000);

                closeScheduleDialog();
                displayTweets(tweetsDataCache);

            } else {
                console.log('❌ [DEBUG] Échec scheduling serveur:', result.error);
                throw new Error(result.error || 'Unknown scheduling error');
            }
        } catch (error) {
            console.error(`❌ [DEBUG] Erreur tentative ${retryCount + 1}:`, error.message);

            if (retryCount < maxRetries) {
                retryCount++;
                console.log(`🔄 [DEBUG] Retry ${retryCount}/${maxRetries} dans ${1000 * retryCount}ms...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                return attemptSchedule();
            }
            throw error;
        }
    }

    try {
        await attemptSchedule();
    } catch (error) {
        console.error('💥 [DEBUG] Échec final scheduling:', error);
        showNotification(`Error: ${error.message}`, 'error');

        // UI feedback échec
        scheduleBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        setTimeout(() => {
            scheduleBtn.innerHTML = originalContent;
            scheduleBtn.disabled = false;
        }, 2000);
    }
    try {
        const status = await checkTwitterStatus(); // Appel à ta fonction checkTwitterStatus
        if (!status.authenticated) {
            showNotification('Connectez Twitter pour scheduler.', 'error');
            authenticateTwitter(); // Prompt connexion
            return;
        }
        // Proceed with formData & fetch
    } catch (error) {
        showNotification('Erreur: ' + error.message, 'error');
    }
}

//new
async function sendTwitterTokensToServer(user, credential) {
    console.log('🐦 [DEBUG] sendTwitterTokensToServer() appelée');
    console.log('👤 [DEBUG] User Firebase:', { uid: user.uid, displayName: user.displayName });
    console.log('🔑 [DEBUG] Credential reçu:', !!credential);

    try {
        const idToken = await user.getIdToken();
        console.log('🎫 [DEBUG] ID Token Firebase récupéré');

        // Extraire les tokens Twitter du credential
        let twitterAccessToken = null;
        let twitterSecret = null;

        if (credential && credential.accessToken && credential.secret) {
            // OAuth 1.0a (Twitter v1)
            twitterAccessToken = credential.accessToken;
            twitterSecret = credential.secret;
            console.log('🔐 [DEBUG] Tokens Twitter OAuth 1.0a extraits');
        } else if (credential && credential.accessToken) {
            // OAuth 2.0 (Twitter v2)
            twitterAccessToken = credential.accessToken;
            console.log('🔐 [DEBUG] Token Twitter OAuth 2.0 extrait');
        } else {
            console.log('⚠️ [DEBUG] Aucun token Twitter trouvé dans credential');
        }

        const payload = {
            twitterAccessToken,
            twitterSecret,
            userInfo: {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL
            }
        };

        console.log('📤 [DEBUG] Envoi vers /api/login:', {
            hasTwitterToken: !!twitterAccessToken,
            hasTwitterSecret: !!twitterSecret,
            uid: user.uid
        });

        const response = await fetch(`${BASE_URL}/api/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify(payload)
        });

        console.log('📥 [DEBUG] Réponse /api/login:', {
            status: response.status,
            ok: response.ok
        });

        const result = await response.json();
        console.log('📋 [DEBUG] Résultat /api/login:', result);

        if (result.success) {
            console.log('✅ [DEBUG] Connexion serveur réussie');
            console.log('🐦 [DEBUG] Twitter connecté:', result.twitterConnected);

            // Stocker les infos localement si nécessaire
            if (result.twitterUser) {
                console.log('👤 [DEBUG] Info Twitter user:', result.twitterUser);
            }

            return result;
        } else {
            console.error('❌ [DEBUG] Échec connexion serveur:', result.error);
            throw new Error(result.error || 'Échec connexion serveur');
        }

    } catch (error) {
        console.error('💥 [DEBUG] Erreur sendTwitterTokensToServer:', error);
        throw error;
    }
}
//mew


// AJOUTER ce code dans votre index.html ou fichier JS principal :

// Fonction pour initier l'authentification Twitter
async function authenticateTwitter() {
  try {
    console.log('🔄 Début authentification Twitter...');

    // Récupérer le token Firebase
    const token = localStorage.getItem('idToken');
    if (!token) {
      throw new Error('Utilisateur non authentifié avec Firebase');
    }

   const response = await fetch('/api/auth/twitter', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Erreur lors de la demande d\'authentification');
    }

    if (!data.success || !data.authUrl) {
      throw new Error('URL d\'authentification non reçue');
    }

    console.log('✅ URL d\'authentification reçue:', data.authUrl);

    // Ajouter le token Firebase à l'URL de callback
    const authUrlWithToken = `${data.authUrl}&firebase_token=${encodeURIComponent(token)}`;

    // Ouvrir la popup d'authentification Twitter
    const popup = window.open(
      data.authUrl,
      'twitter-auth',
      'width=600,height=700,scrollbars=yes,resizable=yes'
    );

    // Écouter la fermeture de la popup
    const checkClosed = setInterval(() => {
      if (popup.closed) {
        clearInterval(checkClosed);
        console.log('🔄 Popup fermée, vérification du statut...');
        checkTwitterStatus();
      }
    }, 1000);

  } catch (error) {
    console.error('❌ Erreur authentification Twitter:', error.message);
    showNotification(`Erreur d'authentification Twitter: ${error.message}`, 'error');
  }
}

// Fonction pour vérifier le statut d'authentification Twitter
async function checkTwitterStatus() {
console.log('🔍 [DEBUG] Vérification statut Twitter...');

    try {
        const response = await fetch(`${BASE_URL}/api/twitter-status`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('idToken')}` }
        });

        const status = await response.json();
        console.log('📊 [DEBUG] Statut Twitter:', status);

        if (status.authenticated && status.user) {
            console.log('✅ [DEBUG] Twitter déjà connecté:', status.user.handle);
            // Optionnel : mettre à jour l'UI pour montrer que Twitter est connecté
        } else {
            console.log('⚠️ [DEBUG] Twitter non connecté côté serveur');
        }

        return status;

    } catch (error) {
        console.error('❌ [DEBUG] Erreur vérification Twitter:', error);
        return { authenticated: false };
    }
  // try {
  //   const token = localStorage.getItem('idToken');
  //   if (!token) {
  //     console.log('❌ Pas de token Firebase');
  //     return;
  //   }
  //
  //   const response = await fetch('/api/twitter-status', {
  //     headers: {
  //       'Authorization': `Bearer ${token}`
  //     }
  //   });
  //
  //   const data = await response.json();
  //   console.log('📊 Statut Twitter:', data);
  //
  //   if (data.authenticated && data.user) {
  //     console.log('✅ Authentification Twitter réussie:', data.user);
  //     // Mettre à jour l'interface utilisateur
  //     updateTwitterUI(data.user);
  //   } else {
  //     console.log('❌ Pas authentifié sur Twitter');
  //     updateTwitterUI(null);
  //   }
  // } catch (error) {
  //   console.error('❌ Erreur vérification statut Twitter:', error.message);
  // }
}
//new


//new

// Fonction pour mettre à jour l'interface utilisateur Twitter
function updateTwitterUI(user) {
  const twitterButton = document.getElementById('twitter-auth-btn');
  const twitterInfo = document.getElementById('twitter-info');

  if (user) {
    // Utilisateur connecté
    if (twitterButton) {
      twitterButton.textContent = 'Déconnexion Twitter';
      twitterButton.onclick = disconnectTwitter;
      twitterButton.classList.add('connected');
    }

    if (twitterInfo) {
      twitterInfo.innerHTML = `
        <div class="twitter-user">
          <img src="${user.profile_picture}" alt="Profile" class="profile-pic">
          <span>${user.username} (${user.handle})</span>
        </div>
      `;
      twitterInfo.style.display = 'block';
    }
  } else {
    // Utilisateur non connecté
    if (twitterButton) {
      twitterButton.textContent = 'Connexion Twitter';
      twitterButton.onclick = authenticateTwitter;
      twitterButton.classList.remove('connected');
    }

    if (twitterInfo) {
      twitterInfo.style.display = 'none';
    }
  }
}

// Fonction pour déconnecter Twitter
async function disconnectTwitter() {
  try {
    const token = localStorage.getItem('idToken');
    if (!token) {
      throw new Error('Token Firebase manquant');
    }

    const response = await fetch('/api/twitter-logout', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (data.success) {
      console.log('✅ Déconnexion Twitter réussie');
      updateTwitterUI(null);
    } else {
      throw new Error(data.error || 'Erreur lors de la déconnexion');
    }
  } catch (error) {
    console.error('❌ Erreur déconnexion Twitter:', error.message);
    showNotification(`Erreur de déconnexion: ${error.message}`, 'error');
  }
}
async function checkTwitterConnectionStatus() {
    console.log('🔍 [DEBUG] Vérification statut Twitter...');
    try {
        const response = await fetch(`${BASE_URL}/api/twitter-status`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('idToken')}` }
        });
        const status = await response.json();
        console.log('📊 [DEBUG] Statut Twitter:', status);

        if (status.authenticated && status.user) {
            console.log('✅ [DEBUG] Twitter connecté:', status.user.handle);
            // Mise à jour UI (ex: bouton -> Déconnecter)
            const twitterBtn = document.createElement('button');
            twitterBtn.id = 'twitter-auth-btn';
            twitterBtn.textContent = 'Déconnexion Twitter';
            twitterBtn.onclick = disconnectTwitter;
            document.querySelector('.header').appendChild(twitterBtn);
            // Charge tweets si connecté
            loadTweets(true);
        } else {
            console.log('⚠️ [DEBUG] Twitter non connecté');
            const twitterBtn = document.createElement('button');
            twitterBtn.id = 'twitter-auth-btn';
            twitterBtn.textContent = 'Connexion Twitter';
            twitterBtn.onclick = authenticateTwitter;
            document.querySelector('.header').appendChild(twitterBtn);
            showNotification('Connectez Twitter pour scheduler des tweets.', 'warning');
        }
    } catch (error) {
        console.error('❌ [DEBUG] Erreur check Twitter:', error);
        showNotification('Erreur vérification Twitter.', 'error');
    }
}

// Appel au load
checkTwitterConnectionStatus();
async function fetchWithAut(url, options = {}) {
    try {
        options.headers = { ...options.headers, 'Authorization': `Bearer ${localStorage.getItem('idToken')}` };
        let response = await fetch(url, options);
        if (response.status === 401) {
            await refreshIdToken();
            options.headers['Authorization'] = `Bearer ${localStorage.getItem('idToken')}`;
            response = await fetch(url, options); // Retry once
        }
        return response;
    } catch (error) {
        throw error;
    }
}

// Vérifier le statut au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  // Vérifier les paramètres URL pour les retours d'authentification
  const urlParams = new URLSearchParams(window.location.search);
  const twitterAuth = urlParams.get('twitter_auth');

  if (twitterAuth === 'success') {
    console.log('✅ Retour d\'authentification Twitter réussie');
    setTimeout(checkTwitterStatus, 1000);
    // Nettoyer l'URL
    window.history.replaceState({}, document.title, window.location.pathname);
  } else if (twitterAuth === 'error') {
    const message = urlParams.get('message') || 'Erreur inconnue';
    console.error('❌ Erreur d\'authentification Twitter:', message);
    showNotification(`Erreur d'authentification Twitter: ${message}`, 'error');
    // Nettoyer l'URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // Vérifier le statut initial
  checkTwitterStatus();
});
        async function loadScheduledTweets() {
            try {
                const headers = {
                    'Authorization': `Bearer ${localStorage.getItem('idToken')}`,
                    ...(lastETag ? { 'If-None-Match': lastETag } : {})
                };
                const response = await fetchWithRetry(`${BASE_URL}/api/tweets`, { headers, signal: AbortSignal.timeout(5000) });
                if (response.status === 401) {
                   window.location.href = '/auth.html';
                    return;
                }
                if (response.status === 304) {
                    console.log('ℹ️ Scheduled tweets unchanged');
                    return;
                }
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                const tweets = await response.json();
                lastETag = response.headers.get('ETag');
                scheduledTweets = tweets.map(tweet => ({
                    ...tweet,
                    datetime: new Date(tweet.datetime),
                    createdAt: new Date(tweet.createdAt),
                    media: tweet.media ? tweet.media.map(m => ({
                        ...m,
                        id: m.id || (m.filename + Math.random()),
                        url: m.url || `${BASE_URL}/uploads/${m.filename}`,
                        type: m.type || (m.mimetype && m.mimetype.startsWith('image/') ? 'image' : 'video'),
                        server: true,
                        mimetype: m.mimetype
                    })) : []
                }));
                tweetSchedules.clear();
                selectedMedia.clear();
                scheduledTweets.forEach(tweet => {
                    const scheduleKey = `${tweet.tweetId}_${tweet.tweetIndex}`;
                    tweetSchedules.set(scheduleKey, tweet.datetime.toISOString());
                    if (tweet.media && tweet.media.length > 0) {
                        selectedMedia.set(scheduleKey, tweet.media);
                    }
                });

                scheduledTweets.forEach(tweet => {
                    const tweetElement = document.getElementById(`tweet_${tweet.tweetId}_${tweet.tweetIndex}_container`);
                    if (tweetElement) {
                        const timestampElement = tweetElement.querySelector('.timestamp');
                        let statusText, statusClass;
                        switch(tweet.status) {
                            case 'scheduled':
                                statusClass = 'status-scheduled';
                                statusText = tweet.datetime <= new Date() ? 'In progress...' : 'Scheduled';
                                break;
                            case 'published':
                                statusClass = 'status-published';
                                statusText = 'Published';
                                break;
                            case 'failed':
                                statusClass = 'status-failed';
                                statusText = 'Failed';
                                break;
                            default:
                                statusClass = '';
                                statusText = '';
                        }
                        timestampElement.innerHTML = `
                            ${formatDate(new Date(tweet.createdAt))}
                            ${statusText ? `<span class="status-indicator ${statusClass}"></span><span style="font-size: 10px; color: #888;">${statusText}${statusText === 'Scheduled' ? ` on ${formatDate(tweet.datetime)}` : ''}</span>` : ''}
                        `;
                        const scheduleKey = `${tweet.tweetId}_${tweet.tweetIndex}`;
                        renderMediaPreview(`tweet_${tweet.tweetId}_${tweet.tweetIndex}`, scheduleKey);
                    }
                });
            } catch (error) {
                console.error('Scheduled tweets loading error:', error);
                showNotification(`Error: ${error.message}.`);
            }
        }

        async function sendUserStyle(style) {
            if (!checkAuth()) return;
            const customInput = document.getElementById('customInput');
            if (!style) {
                showNotification('Please enter a style.');
                return;
            }

            try {
                customInput.disabled = true;
                customInput.classList.add('loading-pulse');

                const response = await fetch(`${BASE_URL}/api/learn-style`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('idToken')}`
                    },
                    body: JSON.stringify({ styleText: style }),
                    signal: AbortSignal.timeout(5000)
                });

                if (response.status === 401) {
                   window.location.href = '/auth.html';
                    return;
                }

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `Network error: ${response.status}`);

                if (result.success) {
                    styleProgress = result.data.styleProgress;
                    updateStyleProgress();
                    customInput.value = '';
                    customInput.placeholder = '✅ Style sent!';
                    setTimeout(() => customInput.placeholder = 'Enter #feedback or your style...', 5000);
                    showNotification('Style sent successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Style sending error:', error);
                showNotification(`Error: ${error.message}.`);
            } finally {
                customInput.disabled = false;
                customInput.classList.remove('loading-pulse');
            }
        }

        async function sendFeedback(message) {
            const customInput = document.getElementById('customInput');
            if (!message) {
                showNotification('Please enter feedback.');
                return;
            }

            try {
                customInput.disabled = true;
                customInput.classList.add('loading-pulse');

                const response = await emailjs.send('service_v0fds5a', 'template_cd6fjit', {
                    message,
                    user_name: document.getElementById('userName').textContent,
                    user_email: window.auth.currentUser?.email || 'noreply@example.com',
                    to_email: 'toumoudagoujoseph@gmail.com',
                    subject: 'Feedback'
                });

                if (response.status === 200) {
                    customInput.value = '';
                    customInput.placeholder = '✅ Feedback sent!';
                    setTimeout(() => customInput.placeholder = 'Enter #feedback or your style...', 5000);
                    showNotification('Feedback sent successfully!', 'success');
                } else {
                    throw new Error(`Unexpected error: ${response.status}`);
                }
            } catch (error) {
                console.error('Feedback sending error:', error);
                showNotification(`Error: ${error.message}`);
            } finally {
                customInput.disabled = false;
                customInput.classList.remove('loading-pulse');
            }
        }

        function setupFilters() {
            const filterTags = document.querySelectorAll('.filter-tag');
            const clearFilter = document.getElementById('clearFilter');

            filterTags.forEach(tag => {
                tag.addEventListener('click', () => {
                    if (tag.classList.contains('selected')) {
                        tag.classList.remove('selected');
                        selectedFilter = null;
                        clearFilter.classList.remove('show');
                    } else {
                        filterTags.forEach(t => t.classList.remove('selected'));
                        tag.classList.add('selected');
                        selectedFilter = tag.dataset.filter;
                        clearFilter.classList.add('show');
                    }
                    displayTweets(tweetsDataCache);
                });
            });

            clearFilter.addEventListener('click', () => {
                filterTags.forEach(tag => tag.classList.remove('selected'));
                selectedFilter = null;
                clearFilter.classList.remove('show');
                displayTweets(tweetsDataCache);
            });
        }

        function setupCustomInput() {
            const customInputBtn = document.getElementById('customInputBtn');
            const customInput = document.getElementById('customInput');

            customInputBtn.addEventListener('click', (e) => {
                if (!customInputBtn.classList.contains('active')) {
                    customInputBtn.classList.add('active');
                    setTimeout(() => customInput.focus(), 300);
                }
            });

            document.addEventListener('click', (e) => {
                if (!customInputBtn.contains(e.target)) {
                    customInputBtn.classList.remove('active');
                }
            });

            customInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && customInput.value.trim()) {
                    const message = customInput.value.trim();
                    if (message.startsWith('#feedback')) {
                        await sendFeedback(message);
                    } else {
                        await sendUserStyle(message);
                    }
                }
            });

            updateStyleProgress();
        }

        document.addEventListener('DOMContentLoaded', () => {

        const urlParams = new URLSearchParams(window.location.search);
    const twitterAuth = urlParams.get('twitter_auth');

    if (twitterAuth === 'success') {
        console.log('🎉 [DEBUG] Retour auth Twitter réussi !');
        showNotification('Twitter connecté avec succès !', 'success');
        // Nettoyer l'URL
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (twitterAuth === 'error') {
        console.log('❌ [DEBUG] Erreur auth Twitter');
        showNotification('Erreur lors de la connexion Twitter', 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // FORCER le rechargement des données
    console.log('🔄 [DEBUG] Rechargement forcé des données...');
    /*await*/ checkTwitterConnectionStatus();
        console.log('🚀 [DEBUG] Page index.html chargée');

            if (!checkAuth()) return;

            setupFilters();
            setupCustomInput();
              // Vérifier si on revient de l'auth Twitter
    // const urlParams = new URLSearchParams(window.location.search);
    // const twitterAuth = urlParams.get('twitter_auth');

    if (twitterAuth === 'success') {
        console.log('🎉 [DEBUG] Retour auth Twitter réussi !');
        showNotification('Twitter connecté avec succès !', 'success');
        // Nettoyer l'URL
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (twitterAuth === 'error') {
        console.log('❌ [DEBUG] Erreur auth Twitter');
        showNotification('Erreur lors de la connexion Twitter', 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Vérifier le statut Twitter
    /*await*/ checkTwitterConnectionStatus();

            const moreBtn = document.getElementById('moreBtn');
            const dropdownMenu = document.getElementById('dropdownMenu');
            moreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!moreBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
            document.getElementById('dropdownLogout').addEventListener('click', () => {
                dropdownMenu.classList.remove('show');
                handleLogout();
            });

            document.getElementById('refreshBtn').addEventListener('click', () => loadTweets(true));

            checkServerStatus().then(() => {
                loadTweets();
                fetchUserStats();
            });
            setInterval(() => loadTweets(), 60000);
            setInterval(refreshIdToken, 1800000);
              document.getElementById('twitter-auth-btn').addEventListener('click', authenticateTwitter);
    checkTwitterStatus();
        });

          const stickers = ["st1.png", "st2.png", "st3.png"];

    // Choisir un sticker aléatoire
    const randomSticker = stickers[Math.floor(Math.random() * stickers.length)];

    // Créer l'élément image
    const img = document.createElement("img");
    img.src = randomSticker;
    img.className = "sticker";

    // Ajouter l'image au profil
    const profileSection = document.querySelector(".profile-section");
    if (profileSection) {
        profileSection.appendChild(img);
    }
    </script>
</body>
</html>
